<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Descarga Videos</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <div class="main-wrapper">
        <div class="container">
            <div class="header-actions">
                <h1>Descarga <span class="gradient-text">Videos</span></h1>
            </div>

            <!-- Paso 1: URL -->
            <div id="step-url" class="step-section">
                <div class="input-group">
                    <input type="text" id="urlInput"
                        placeholder="Pega el enlace del video aquí (YouTube, Twitch, etc)..." autocomplete="off">
                    <button id="btnCheck" class="btn-icon"><i class="fas fa-search"></i></button>
                </div>
            </div>

            <!-- Paso 2: Info y Configuración -->
            <div id="step-info" class="step-section hidden">
                <div class="video-card">
                    <img id="videoThumb" src="" alt="Thumbnail">
                    <div class="video-details">
                        <h3 id="videoTitle">Título del Video</h3>
                        <p>
                            <i class="far fa-clock"></i> <span id="videoDuration">00:00</span> |
                            <i class="far fa-user"></i> <span id="videoUploader">Autor</span>
                        </p>
                    </div>
                </div>

                <div class="config-grid">
                    <div class="config-item">
                        <label>Tipo</label>
                        <div class="toggle-group">
                            <button class="toggle-btn active" data-type="video" onclick="setType('video')"><i
                                    class="fas fa-video"></i> Video</button>
                            <button class="toggle-btn" data-type="audio" onclick="setType('audio')"><i
                                    class="fas fa-music"></i> Audio</button>
                        </div>
                    </div>

                    <div class="config-item" id="qualityGroup">
                        <label>Calidad</label>
                        <select id="qualitySelect">
                            <option value="best">Mejor Posible</option>
                            <option value="4k">4K / 2160p</option>
                            <option value="1080p" selected>Full HD / 1080p</option>
                            <option value="720p">HD / 720p</option>
                        </select>
                    </div>

                    <div class="config-item full-width">
                        <label class="checkbox-container">
                            <input type="checkbox" id="subsCheckbox" onchange="toggleSubsOptions()">
                            <span class="checkmark"></span>
                            <span class="label-text"><i class="fas fa-closed-captioning"></i> Descargar Subtítulos
                                (.srt)</span>
                        </label>
                    </div>

                    <div class="config-item full-width">
                        <label class="checkbox-container">
                            <input type="checkbox" id="playlistCheckbox">
                            <span class="checkmark"></span>
                            <span class="label-text"><i class="fas fa-list"></i> Descargar toda la playlist (si
                                aplica)</span>
                        </label>
                    </div>

                    <div class="config-item full-width hidden" id="subsOptions">
                        <label>Idioma de Subtítulos</label>
                        <select id="subsLangSelect">
                            <option value="all">Todos los disponibles</option>
                        </select>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn-secondary" onclick="resetStep()"><i class="fas fa-arrow-left"></i> Atrás</button>
                    <button class="btn-primary" onclick="startDownload()"><i class="fas fa-download"></i>
                        Descargar</button>
                </div>
            </div>

            <!-- Paso 3: Progreso -->
            <div id="step-progress" class="step-section hidden">
                <div class="progress-info">
                    <span id="progressStatus">Iniciando...</span>
                    <span id="progressPercent">0%</span>
                </div>
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="progress-meta">
                    <span><i class="fas fa-tachometer-alt"></i> <span id="speed">0 MiB/s</span></span>
                    <span><i class="fas fa-hourglass-half"></i> <span id="eta">00:00</span></span>
                </div>
                <button class="btn-danger mt-4" onclick="cancelDownload()"><i class="fas fa-stop"></i> Cancelar</button>
            </div>
        </div>

        <!-- Historial -->
        <div class="history-container">
            <h2><i class="fas fa-history"></i> Historial de Descargas</h2>
            <div id="historyList" class="history-list">
                <!-- Items generados por JS -->
            </div>
        </div>
    </div>

    <script>
        let currentUrl = '';
        let currentType = 'video';
        let currentTaskId = null;
        let pollInterval = null;
        let historyInterval = null;
        let availableSubs = [];

        // Event Listeners
        document.getElementById('urlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') checkUrl();
        });
        document.getElementById('btnCheck').addEventListener('click', checkUrl);

        function setType(type) {
            currentType = type;
            document.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
            document.querySelector(`.toggle-btn[data-type="${type}"]`).classList.add('active');

            const qGroup = document.getElementById('qualityGroup');
            if (type === 'audio') qGroup.style.opacity = '0.5';
            else qGroup.style.opacity = '1';
        }

        function toggleSubsOptions() {
            const checked = document.getElementById('subsCheckbox').checked;
            const opts = document.getElementById('subsOptions');
            if (checked && availableSubs.length > 0) {
                opts.classList.remove('hidden');
            } else {
                opts.classList.add('hidden');
            }
        }

        async function checkUrl() {
            const url = document.getElementById('urlInput').value.trim();
            if (!url) return;

            currentUrl = url;
            showLoader(true);

            try {
                const res = await fetch('/api/info', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });
                const data = await res.json();

                if (data.error) throw new Error(data.error);

                document.getElementById('videoTitle').textContent = data.title;
                document.getElementById('videoThumb').src = data.thumbnail;
                document.getElementById('videoDuration').textContent = data.duration;
                document.getElementById('videoUploader').textContent = data.uploader;

                // Procesar subtítulos
                availableSubs = data.subtitles || [];
                const subSelect = document.getElementById('subsLangSelect');
                subSelect.innerHTML = '<option value="all">Todos los disponibles</option>';

                if (availableSubs.length > 0) {
                    availableSubs.forEach(lang => {
                        const opt = document.createElement('option');
                        opt.value = lang;
                        opt.textContent = lang;
                        subSelect.appendChild(opt);
                    });
                }

                // Resetear UI de subs
                document.getElementById('subsCheckbox').checked = false;
                toggleSubsOptions();

                showStep('info');
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                showLoader(false);
            }
        }

        async function startDownload() {
            const quality = document.getElementById('qualitySelect').value;
            const subtitles = document.getElementById('subsCheckbox').checked;
            const subtitleLang = document.getElementById('subsLangSelect').value;
            const downloadPlaylist = document.getElementById('playlistCheckbox').checked;
            showStep('progress');

            try {
                const res = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: currentUrl,
                        format: currentType,
                        quality: quality,
                        subtitles: subtitles,
                        subtitle_lang: subtitleLang,
                        download_playlist: downloadPlaylist
                    })
                });
                const data = await res.json();
                currentTaskId = data.task_id;
                startPolling();
            } catch (e) {
                alert('Error al iniciar: ' + e.message);
                resetStep();
            }
        }

        async function cancelDownload() {
            if (!currentTaskId) return;
            if (!confirm('¿Seguro que quieres cancelar?')) return;

            await fetch('/api/cancel', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: currentTaskId })
            });
        }

        function startPolling() {
            if (pollInterval) clearInterval(pollInterval);

            pollInterval = setInterval(async () => {
                const res = await fetch(`/api/status/${currentTaskId}`);
                const status = await res.json();

                const bar = document.getElementById('progressBar');
                const txt = document.getElementById('progressStatus');
                const pct = document.getElementById('progressPercent');

                bar.style.width = status.progress + '%';
                pct.textContent = status.progress.toFixed(1) + '%';

                document.getElementById('speed').textContent = status.speed || '--';
                document.getElementById('eta').textContent = status.eta || '--';

                if (status.status === 'downloading') {
                    txt.textContent = 'Descargando...';
                } else if (status.status === 'processing') {
                    txt.textContent = 'Procesando...';
                    bar.style.backgroundColor = '#f59e0b';
                } else if (status.status === 'completed') {
                    clearInterval(pollInterval);
                    txt.textContent = '¡Completado!';
                    bar.style.backgroundColor = '#10b981';
                    loadHistory();

                    if (status.filename) {
                        window.location.href = `/downloads/${status.filename}`;
                    } else if (status.is_playlist) {
                        alert('Playlist descargada correctamente. Disponible en el historial.');
                    } else {
                        alert('Descarga completada. Revisa el historial.');
                    }

                    setTimeout(resetStep, 3000);
                } else if (status.status === 'error' || status.status === 'cancelled') {
                    clearInterval(pollInterval);
                    alert('Estado: ' + status.status + (status.error ? '\n' + status.error : ''));
                    resetStep();
                }
            }, 1000);
        }

        // --- History & Timer Logic ---
        async function loadHistory() {
            const res = await fetch('/api/history');
            const files = await res.json();
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            files.forEach(f => {
                const item = document.createElement('div');
                item.className = 'history-item';

                // Formatear tiempo restante
                const h = Math.floor(f.remaining_seconds / 3600);
                const m = Math.floor((f.remaining_seconds % 3600) / 60);
                const s = f.remaining_seconds % 60;
                const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;

                // Color de urgencia
                let timerClass = 'timer-normal';
                if (f.remaining_seconds < 300) timerClass = 'timer-danger'; // < 5 min

                let icon = 'fa-file-video';
                let downloadBtn = `<a href="/downloads/${f.name}" class="btn-icon small" title="Descargar"><i class="fas fa-download"></i></a>`;

                if (f.type === 'playlist') {
                    icon = 'fa-folder';
                    downloadBtn = `<button class="btn-icon small disabled" disabled title="Es una carpeta"><i class="fas fa-folder-open"></i></button>`;
                }

                item.innerHTML = `
                    <div class="file-info">
                        <div class="file-name"><i class="fas ${icon}"></i> ${f.name}</div>
                        <div class="file-meta">
                            ${(f.size / 1024 / 1024).toFixed(2)} MB | 
                            <span class="${timerClass}"><i class="fas fa-stopwatch"></i> ${timeStr}</span>
                        </div>
                    </div>
                    <div class="file-actions">
                        ${downloadBtn}
                        <button onclick="deleteFile('${f.name}')" class="btn-icon small danger" title="Borrar"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                list.appendChild(item);
            });
        }

        // Refrescar historial cada 10s para actualizar temporizadores
        if (historyInterval) clearInterval(historyInterval);
        historyInterval = setInterval(loadHistory, 10000);

        async function deleteFile(name) {
            if (!confirm(`¿Eliminar ${name}?`)) return;
            await fetch(`/api/files/${name}`, { method: 'DELETE' });
            loadHistory();
        }

        // UI Helpers
        function showStep(stepId) {
            document.querySelectorAll('.step-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${stepId}`).classList.remove('hidden');
        }

        function resetStep() {
            currentUrl = '';
            document.getElementById('urlInput').value = '';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').style.backgroundColor = 'var(--accent-color)';
            showStep('url');
        }

        function showLoader(show) {
            const btn = document.getElementById('btnCheck');
            if (show) btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            else btn.innerHTML = '<i class="fas fa-search"></i>';
        }

        // Init
        loadHistory();
    </script>
</body>

</html>